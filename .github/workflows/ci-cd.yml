name: ğŸ§ª Tests Pipeline - Unit & E2E Only

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

# Variables d'environnement
env:
  NODE_VERSION: "18.x"
  FRONTEND_PORT: 3000
  BACKEND_PORT: 3001

jobs:
  # ==========================================
  # JOB 1: TESTS UNITAIRES API
  # ==========================================
  unit-tests:
    name: ğŸ§ª Tests Unitaires API
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd server && npm ci

      - name: ğŸ§ª Run Unit Tests
        run: |
          cd server && npm run test:unit

      - name: ğŸ“Š Generate Test Coverage
        run: |
          cd server && npm run test:coverage

      - name: ğŸ“ˆ Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-coverage
          path: server/coverage/

      - name: ğŸ“‹ Display Test Results
        if: always()
        run: |
          echo "## ğŸ§ª Unit Tests Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests unitaires de l'API exÃ©cutÃ©s" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # JOB 2: BUILD & SERVICES (pour E2E)
  # ==========================================
  build-services:
    name: ğŸ—ï¸ Build Services for E2E
    runs-on: ubuntu-latest
    needs: unit-tests

    outputs:
      services-ready: ${{ steps.health-check.outputs.services-status }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd server && npm ci

      - name: ğŸ—ï¸ Build Applications
        run: npm run build

      - name: ğŸš€ Start Backend Server
        run: |
          cd server && npm start &
          echo $! > backend.pid
          sleep 15

      - name: ğŸš€ Start Frontend Server
        run: |
          npm run start:next &
          echo $! > frontend.pid
          sleep 20

      - name: ğŸ¥ Health Check Services
        id: health-check
        run: |
          # Test Backend API
          backend_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${{ env.BACKEND_PORT }}/health || echo "000")

          # Test Frontend
          frontend_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${{ env.FRONTEND_PORT }} || echo "000")

          if [ "$backend_status" = "200" ] && [ "$frontend_status" = "200" ]; then
            echo "services-status=ready" >> $GITHUB_OUTPUT
            echo "âœ… Services dÃ©marrÃ©s avec succÃ¨s"
          else
            echo "services-status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Ã‰chec dÃ©marrage services"
            exit 1
          fi

      - name: ğŸ§ª Quick API Test
        run: |
          # Test CRUD de base
          curl -f http://localhost:${{ env.BACKEND_PORT }}/api/tasks || exit 1

          # Test crÃ©ation tÃ¢che
          curl -f -X POST http://localhost:${{ env.BACKEND_PORT }}/api/tasks \
            -H "Content-Type: application/json" \
            -d '{"title":"Test CI","completed":false}' || exit 1

      - name: ğŸ›‘ Cleanup
        if: always()
        run: |
          if [ -f backend.pid ]; then kill $(cat backend.pid) 2>/dev/null || true; fi
          if [ -f frontend.pid ]; then kill $(cat frontend.pid) 2>/dev/null || true; fi

  # ==========================================
  # JOB 3: TESTS END-TO-END
  # ==========================================
  e2e-tests:
    name: ğŸ­ Tests E2E - ${{ matrix.test-suite }}
    runs-on: ubuntu-latest
    needs: build-services
    if: needs.build-services.outputs.services-ready == 'ready'

    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - task-creation
          - task-reading
          - task-update
          - task-deletion
          - user-workflows
          - error-handling
          - crud-operations

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd server && npm ci

      - name: ğŸ—ï¸ Build Applications
        run: npm run build

      - name: ğŸ­ Run Cypress E2E Tests
        uses: cypress-io/github-action@v6
        with:
          start: |
            cd server && npm start
            npm run start:next
          wait-on: |
            http://localhost:${{ env.BACKEND_PORT }}/health
            http://localhost:${{ env.FRONTEND_PORT }}
          wait-on-timeout: 180
          browser: chrome
          headless: true
          spec: cypress/e2e/todo/${{ matrix.test-suite }}.cy.ts
          config: |
            {
              "baseUrl": "http://localhost:${{ env.FRONTEND_PORT }}",
              "env": {
                "API_URL": "http://localhost:${{ env.BACKEND_PORT }}/api"
              },
              "video": true,
              "screenshotOnRunFailure": true
            }

      - name: ğŸ“Š Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-failure-${{ matrix.test-suite }}
          path: |
            cypress/screenshots
            cypress/videos

      - name: ğŸ“‹ Test Results Summary
        if: always()
        run: |
          echo "## ğŸ­ E2E Tests - ${{ matrix.test-suite }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Tests E2E rÃ©ussis pour ${{ matrix.test-suite }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests E2E Ã©chouÃ©s pour ${{ matrix.test-suite }}" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================
  # JOB 4: RAPPORT FINAL SIMPLIFIÃ‰
  # ==========================================
  test-report:
    name: ğŸ“‹ Tests Summary Report
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests]
    if: always()

    steps:
      - name: ğŸ“Š Generate Tests Report
        run: |
          echo "# ğŸ§ª Tests Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Tests Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Unit Tests API | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ­ E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.unit-tests.result }}" = "success" ] && [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "## âœ… Tous les tests sont passÃ©s avec succÃ¨s !" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ¯ Application prÃªte pour Ã©valuation" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Certains tests nÃ©cessitent une attention" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ” Consultez les dÃ©tails des jobs pour plus d'informations" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ‰ Success Notification
        if: needs.unit-tests.result == 'success' && needs.e2e-tests.result == 'success'
        run: |
          echo "ğŸ‰ SUCCESS: Tous les tests unitaires et E2E sont passÃ©s !"
          echo "ğŸ“Š Pipeline de tests optimisÃ© fonctionnel"

      - name: âŒ Failure Notification
        if: needs.unit-tests.result == 'failure' || needs.e2e-tests.result == 'failure'
        run: |
          echo "âŒ ATTENTION: Des tests ont Ã©chouÃ©"
          echo "ğŸ› ï¸ VÃ©rifiez les logs pour identifier les problÃ¨mes"
          exit 1
